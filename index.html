<!doctype html><html lang="da"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Min Fryser (Cloudflare Sync)</title><link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#0b5cff">
<style>body{margin:0;font-family:system-ui;background:linear-gradient(145deg,#0b5cff,#2c7dff)}.container{max-width:1024px;margin:0 auto;padding:16px}
h1{margin:0;color:#fff}.card{background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(0,0,0,.1);padding:14px;margin:12px 0}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}thead th{font-size:12px;color:#5a6b9c;text-align:left;padding:0 8px}
tbody tr{background:#fff;box-shadow:0 8px 28px rgba(0,0,0,.1);border-radius:12px;overflow:hidden}tbody td{padding:12px 8px}
@media(max-width:700px){.table,thead,tbody,th,td,tr{display:block;width:100%}thead{display:none}tbody tr{padding:10px}
tbody td{display:grid;grid-template-columns:130px 1fr;gap:6px;padding:10px 8px}tbody td::before{content:attr(data-label);font-size:12px;color:#5a6b9c}}</style>
</head><body><div class="container">
<header style="display:flex;align-items:center;gap:12px;color:#fff;padding:18px 8px 12px"><img src="logo.png" width="40" height="40" style="border-radius:12px"/>
<div style="flex:1"><h1>Min Fryser <small id="v" style="opacity:.85;font-size:12px;margin-left:8px"></small></h1>
<div id="syncText" style="opacity:.95">Initialiserer…</div></div>
<button id="hardUpdate">Opdater app</button></header>
<div class="card"><div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
<button id="createHousehold">Opret ny husstand</button>
<input id="householdId" placeholder="Husstands-ID" style="min-width:220px;flex:1 1 auto"/>
<button id="applyHousehold">Brug ID</button><button id="copyShare">Kopiér delingslink</button></div>
<small>Alle med delingslinket kan se og ændre listen. Del kun med din husstand.</small></div>
<div class="card"><form id="itemForm">
<div style="display:grid;gap:12px">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div><label>Vare *</label><input id="name" required></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div><label>Mængde</label><input id="qty" type="number" min="0" step="0.1" value="1"></div>
<div><label>Enhed</label><select id="unit"><option>stk</option><option>poser</option><option>g</option><option>kg</option><option>ml</option><option>l</option></select></div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div><label>Kategori</label><select id="category"><option value="">(vælg)</option><option>Kød</option><option>Fisk</option><option>Grønt</option><option>Frugt</option><option>Brød</option><option>Mejeri</option><option>Færdigret</option><option>Is/dessert</option><option>Andet</option></select></div>
<div><label>Placering</label><select id="location"><option value="">(vælg)</option><option>Køkkenfryse</option><option>Kummefryser</option></select></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div><label>Dato indfrosset</label><input id="frozenDate" type="date"></div><div><label>Bedst før</label><input id="bestBefore" type="date"></div></div>
<div><label>Noter</label><textarea id="notes"></textarea></div>
<div style="display:flex;gap:10px;flex-wrap:wrap"><button type="submit" id="saveBtn">Gem</button><button type="button" id="resetBtn">Ryd formular</button><span id="formStatus"></span></div>
</div><input type="hidden" id="itemId"></form></div>
<div class="card"><table class="table"><thead><tr><th>Vare</th><th>Mængde</th><th>Kategori</th><th>Placering</th><th>Indfrosset</th><th>Bedst før</th><th>Status</th><th>Handlinger</th></tr></thead><tbody id="itemsBody"></tbody></table></div>
<div style="color:#fff" id="counts"></div>
</div>
<script>
const APP_VERSION='v4-2025-11-04';document.getElementById('v').textContent=APP_VERSION;
const $=s=>document.querySelector(s);const today=()=>new Date().toISOString().slice(0,10);
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
const fmt=s=>s?new Date(s).toLocaleDateString('da-DK'):'—';const now=()=>Date.now();
const STORAGE_KEY='freezerItemsSyncV1', HOUSEHOLD_KEY='freezerHouseholdV1', API='/api/sync';
let items=[], householdId='', version=0, syncing=false;
function loadLocal(){try{items=JSON.parse(localStorage.getItem(STORAGE_KEY))||[];householdId=localStorage.getItem(HOUSEHOLD_KEY)||'';}catch(e){items=[];householdId='';}}
function saveLocal(){localStorage.setItem(STORAGE_KEY,JSON.stringify(items));localStorage.setItem(HOUSEHOLD_KEY,householdId||'');}
function setHousehold(id){householdId=(id||'').trim();saveLocal();$('#householdId').value=householdId;const u=new URL(location.href);u.searchParams.set('h',householdId||'');history.replaceState(null,'',u.toString());}
async function copyShare(){const u=new URL(location.href);u.searchParams.set('h',householdId);try{await navigator.clipboard.writeText(u.toString());alert('Delingslink kopieret ✔');}catch(e){prompt('Kopiér delingslink:',u.toString());}}
function ds(d){if(!d)return null;const D=new Date(d+'T00:00:00'),N=new Date(today());return Math.round((D-N)/(1000*60*60*24));}
function badge(it){const d=ds(it.bestBefore);if(d===null)return '<span>Ingen dato</span>';if(d<0)return `<span>Udløbet ${Math.abs(d)} d.</span>`;if(d<=3)return `<span>Meget snart (${d} d.)</span>`;if(d<=7)return `<span>Snart (${d} d.)</span>`;return `<span>${d} d.</span>`;}
function render(){const tbody=$('#itemsBody');tbody.innerHTML='';for(const it of items){const tr=document.createElement('tr');tr.dataset.id=it.id;tr.innerHTML=`
<td data-label="Vare"><strong>${it.name||''}</strong>${it.notes?'<br><small>'+it.notes+'</small>':''}</td>
<td data-label="Mængde">${Number(it.qty||0)} ${it.unit||''}</td>
<td data-label="Kategori">${it.category||'—'}</td>
<td data-label="Placering">${it.location||'—'}</td>
<td data-label="Indfrosset">${fmt(it.frozenDate)}</td>
<td data-label="Bedst før">${fmt(it.bestBefore)}</td>
<td data-label="Status">${badge(it)}</td>
<td data-label="Handlinger"><button data-a="inc">+1</button><button data-a="dec">-1</button><button data-a="edit">Rediger</button><button data-a="delete">Slet</button></td>`;tbody.appendChild(tr);}}
function resetForm(c=true){$('#itemForm').reset();$('#frozenDate').value=today();if(c)$('#itemId').value='';$('#saveBtn').textContent='Gem';}
function addOrUpdate(){const id=$('#itemId').value||uid();const it={id,name:$('#name').value.trim(),qty:parseFloat($('#qty').value||0),unit:$('#unit').value,category:$('#category').value,location:$('#location').value,frozenDate:$('#frozenDate').value||null,bestBefore:$('#bestBefore').value||null,notes:$('#notes').value.trim(),lastUpdated:now()};if(!it.name){$('#formStatus').textContent='Varenavn er påkrævet.';return;}const idx=items.findIndex(x=>x.id===id);if(idx>=0)items[idx]=it;else items.push(it);saveLocal();render();$('#formStatus').textContent='Gemt ✔';resetForm(false);queuePush();}
function softDelete(id){const i=items.findIndex(x=>x.id===id);if(i<0)return;items[i]={...items[i],_deleted:true,lastUpdated:now()};saveLocal();render();queuePush();}
function incDec(id,delta){const it=items.find(x=>x.id===id);if(!it)return;it.qty=Math.max(0,(parseFloat(it.qty)||0)+delta);it.lastUpdated=now();saveLocal();render();queuePush();}
async function pull(){if(!householdId)return;syncing=true;try{const r=await fetch(`${API}?id=${encodeURIComponent(householdId)}&_=${Date.now()}`,{method:'GET',cache:'no-store'});const data=await r.json();if(!data.ok)throw 0;const sMap=new Map((data.items||[]).map(i=>[i.id,i]));const lMap=new Map((items||[]).map(i=>[i.id,i]));for(const [id,si] of sMap){const li=lMap.get(id);const sLU=Number(si.lastUpdated||0),lLU=Number(li?.lastUpdated||0);if(!li||sLU>lLU)lMap.set(id,si);}items=[...lMap.values()].filter(x=>!x._deleted);version=data.version||0;saveLocal();render();$('#syncText').textContent='Online og synkroniseret';}catch(e){$('#syncText').textContent='Sync-fejl – arbejder offline.';}finally{syncing=false;}}
let syncQueued=false;function queuePush(){if(syncQueued)return;syncQueued=true;setTimeout(async()=>{syncQueued=false;await push();},600);}
async function push(){if(!householdId)return;syncing=true;try{const r=await fetch(`${API}?id=${encodeURIComponent(householdId)}&_=${Date.now()}`,{method:'POST',headers:{'Content-Type':'application/json'},cache:'no-store',body:JSON.stringify({items,version,clientId:uid()})});const data=await r.json();if(!data.ok)throw 0;items=(data.items||[]).filter(x=>!x._deleted);version=data.version||(version+1);saveLocal();render();$('#syncText').textContent='Online og synkroniseret';}catch(e){$('#syncText').textContent='Sync-fejl – arbejder offline.';}finally{syncing=false;}}
async function hardUpdate(){try{if('caches' in window){const keys=await caches.keys();await Promise.all(keys.map(k=>caches.delete(k)));}if('serviceWorker' in navigator){const regs=await navigator.serviceWorker.getRegistrations();await Promise.all(regs.map(r=>r.unregister()));}}catch(e){}location.reload();}
document.addEventListener('DOMContentLoaded',async()=>{loadLocal();const sp=new URLSearchParams(location.search);const h=sp.get('h');if(h)householdId=h;$('#householdId').value=householdId;$('#frozenDate').value=today();render();$('#itemForm').addEventListener('submit',e=>{e.preventDefault();addOrUpdate();});$('#resetBtn').addEventListener('click',()=>resetForm());$('#itemsBody').addEventListener('click',e=>{const b=e.target.closest('button');if(!b)return;const tr=e.target.closest('tr');const id=tr?.dataset?.id;if(!id)return;const ac=b.dataset.a;if(ac==='inc')incDec(id,+1);if(ac==='dec')incDec(id,-1);if(ac==='delete')if(confirm('Slet?'))softDelete(id);if(ac==='edit'){const it=items.find(x=>x.id===id);if(it){$('#itemId').value=it.id;$('#name').value=it.name||'';$('#qty').value=it.qty||0;$('#unit').value=it.unit||'stk';$('#category').value=it.category||'';const sel=$('#location');if(it.location && !Array.from(sel.options).some(o=>o.value===it.location)){const opt=document.createElement('option');opt.value=it.location;opt.textContent=it.location;sel.appendChild(opt);}sel.value=it.location||'';$('#frozenDate').value=it.frozenDate||'';$('#bestBefore').value=it.bestBefore||'';$('#notes').value=it.notes||'';$('#saveBtn').textContent='Opdatér';}}});$('#createHousehold').addEventListener('click',()=>{const id=Array.from({length:20},()=>Math.floor(Math.random()*36).toString(36)).join('');setHousehold(id);alert('Ny husstand oprettet ✔');queuePush();});$('#applyHousehold').addEventListener('click',()=>setHousehold($('#householdId').value));$('#copyShare').addEventListener('click',copyShare);$('#hardUpdate').addEventListener('click',hardUpdate);if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}await pull();setInterval(pull,30000);});
</script></body></html>