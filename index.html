<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Min Fryser (Cloudflare Sync)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b5cff">
<style>
:root{
  --bg:#0b5cff;--ink:#0b1320;--muted:#5a6b9c;--card:#ffffff;
  --accent:#0b5cff;--danger:#c7232f;--warn:#b36a00;--ok:#0b7d3b;
  --radius:16px;--shadow:0 8px 28px rgba(11,19,32,0.10)
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,'Noto Sans',sans-serif;color:var(--ink);
  background:linear-gradient(145deg,var(--bg) 0%,#1b6cff 60%,#2c7dff 100%)}
.container{max-width:1024px;margin:0 auto;padding:16px}
header{color:#fff;padding:18px 8px 12px;display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:clamp(20px,4.5vw,32px)}
.logo{width:40px;height:40px;flex:0 0 auto;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.15)}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:12px 0}
.grid{display:grid;gap:12px}
@media(min-width:880px){.grid-2{grid-template-columns:1fr 1.1fr}}
fieldset{border:1px solid #e6e8f0;border-radius:12px;padding:12px}
legend{padding:0 8px;color:var(--muted)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="text"],input[type="number"],input[type="date"],select,textarea{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d9deea;background:#fff;font-size:16px}
textarea{min-height:60px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.row{grid-template-columns:1fr}}
button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700;font-size:16px}
.btn{background:var(--accent);color:#fff}
.btn.secondary{background:#eef2ff;color:#1e2a55}
.btn.warn{background:var(--warn);color:#fff}
.btn.danger{background:#c7232f;color:#fff}
.btn.ghost{background:transparent;border:1px solid #d9deea;color:#1e244d}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
tbody tr{background:#fff;box-shadow:var(--shadow);border-radius:12px;overflow:hidden}
tbody td{padding:12px 8px;vertical-align:top}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:#eef2ff;color:#1e244d;margin-right:4px}
.badge.expiring{background:#fff4d9;color:#7a4b00}
.badge.expired{background:#ffe3e6;color:#7a0011}
.badge.ok{background:#e9fff3;color:#005222}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.actions .btn{flex:1 1 48%; min-width:44px}
.counts{color:#fff;opacity:0.95;display:flex;gap:14px;flex-wrap:wrap}
small.help{color:var(--muted)}
kbd{background:#eef1ff;border:1px solid #dfe3ff;border-radius:6px;padding:2px 6px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Liberation Mono',monospace}
.status{display:flex;align-items:center;gap:8px;color:#fff;opacity:0.95;margin-left:auto}
.status .dot{width:10px;height:10px;border-radius:999px;background:#ffd147}
.status.ok .dot{background:#13b24c}
.status.off .dot{background:#ffd147}
.status.err .dot{background:#ff4056}

@media(max-width:700px){
  /* Responsive table → cards */
  .table, thead, tbody, th, td, tr { display:block; width:100% }
  thead { display:none }
  tbody tr { padding:10px }
  tbody td { display:grid; grid-template-columns: 130px 1fr; align-items:start; gap:6px; padding:10px 8px }
  tbody td::before { content: attr(data-label); font-size:12px; color:var(--muted) }
  .actions { margin-top:6px }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <img src="logo.png" alt="Fryser" class="logo" />
    <div>
      <h1>Min Fryser</h1>
      <div class="status" id="syncStatus"><span class="dot"></span><span id="syncText">Initialiserer…</span></div>
    </div>
  </header>

  <div class="card">
    <fieldset>
      <legend>Husstand</legend>
      <div class="toolbar" style="gap:8px">
        <button class="btn secondary" id="createHousehold">Opret ny husstand</button>
        <input class="inline" id="householdId" placeholder="Husstands-ID (skriv eller indsæt)" style="min-width:220px;flex:1 1 auto"/>
        <button class="btn" id="applyHousehold">Brug ID</button>
        <button class="btn ghost" id="copyShare">Kopiér delingslink</button>
      </div>
      <small class="help">Alle med delingslinket kan se og ændre listen. Del kun med din husstand.</small>
    </fieldset>
  </div>

  <div class="card grid grid-2">
    <form id="itemForm" class="grid" autocomplete="off">
      <fieldset class="grid">
        <legend>Tilføj / redigér</legend>
        <div class="row">
          <div>
            <label for="name">Vare *</label>
            <input id="name" name="name" type="text" required placeholder="Fx 'Kyllingebryst'">
          </div>
          <div class="row">
            <div>
              <label for="qty">Mængde</label>
              <input id="qty" name="qty" type="number" min="0" step="0.1" value="1">
            </div>
            <div>
              <label for="unit">Enhed</label>
              <select id="unit" name="unit">
                <option>stk</option><option>poser</option><option>g</option><option>kg</option><option>ml</option><option>l</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="category">Kategori</label>
            <select id="category" name="category">
              <option value="">(vælg)</option>
              <option>Kød</option><option>Fisk</option><option>Grønt</option><option>Frugt</option>
              <option>Brød</option><option>Mejeri</option><option>Færdigret</option><option>Is/dessert</option><option>Andet</option>
            </select>
          </div>
          <div>
            <label for="location">Placering</label>
            <select id="location" name="location">
              <option value="">(vælg)</option>
              <option>Køkkenfryse</option>
              <option>Kummefryser</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="frozenDate">Dato indfrosset</label>
            <input id="frozenDate" name="frozenDate" type="date">
          </div>
          <div>
            <label for="bestBefore">Bedst før</label>
            <input id="bestBefore" name="bestBefore" type="date">
          </div>
        </div>
        <div>
          <label for="notes">Noter</label>
          <textarea id="notes" name="notes" placeholder="Fx 'Marineret' eller 'til suppe'"></textarea>
        </div>
        <div class="toolbar">
          <button type="submit" class="btn" id="saveBtn">Gem</button>
          <button type="button" class="btn secondary" id="resetBtn">Ryd formular</button>
          <span id="formStatus" role="status" aria-live="polite"></span>
        </div>
      </fieldset>
      <input type="hidden" id="itemId" name="itemId" value="">
    </form>

    <div class="grid">
      <fieldset>
        <legend>Filtre & sortering</legend>
        <div class="row">
          <div>
            <label for="search">Søg</label>
            <input id="search" type="text" placeholder="Søg efter vare, kategori, placering…">
          </div>
          <div>
            <label for="filterCategory">Kategori</label>
            <select id="filterCategory">
              <option value="">Alle</option>
              <option>Kød</option><option>Fisk</option><option>Grønt</option><option>Frugt</option>
              <option>Brød</option><option>Mejeri</option><option>Færdigret</option><option>Is/dessert</option><option>Andet</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="sortBy">Sorter efter</label>
            <select id="sortBy">
              <option value="name">Navn (A→Å)</option>
              <option value="frozenDate">Indfrosset (nyeste først)</option>
              <option value="bestBefore">Bedst før (tættest først)</option>
              <option value="qty">Mængde (størst først)</option>
            </select>
          </div>
          <div>
            <label for="expSoon">Vis der udløber inden</label>
            <select id="expSoon">
              <option value="0" selected>Alle</option>
              <option value="3">3 dage</option>
              <option value="7">7 dage</option>
              <option value="14">14 dage</option>
              <option value="30">30 dage</option>
            </select>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="exportCsv">Eksportér CSV</button>
          <input type="file" id="importFile" accept=".csv" style="display:none">
          <button class="btn ghost" id="importCsv">Importér CSV</button>
          <button class="btn warn" id="clearAll">Slet alt</button>
          <span class="small help" aria-live="polite" id="status"></span>
        </div>
        <small class="help">Tip: Marker en række og tryk <kbd>+</kbd>/<kbd>-</kbd> for at ændre mængden hurtigt.</small>
      </fieldset>
    </div>
  </div>

  <div class="card">
    <table class="table" id="itemsTable">
      <thead>
        <tr>
          <th>Vare</th>
          <th>Mængde</th>
          <th>Kategori</th>
          <th>Placering</th>
          <th>Indfrosset</th>
          <th>Bedst før</th>
          <th>Status</th>
          <th>Handlinger</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <footer>
    <div class="counts" id="counts"></div>
  </footer>
</div>

<script>
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
const todayStr = () => new Date().toISOString().slice(0,10);
const parseDate = (s) => s ? new Date(s + 'T00:00:00') : null;
const fmt = (s) => s ? new Date(s).toLocaleDateString('da-DK') : '—';
const uid = () => (Date.now().toString(36) + Math.random().toString(36).slice(2,8));
const nowMs = () => Date.now();
const escapeHtml = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));

const STORAGE_KEY = 'freezerItemsSyncV1';
const HOUSEHOLD_KEY = 'freezerHouseholdV1';
const API = '/api/sync';

let items = [];
let householdId = '';
let version = 0;
let syncing = false;
let clientId = uid();

function loadLocal(){
  try{ items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; householdId = localStorage.getItem(HOUSEHOLD_KEY) || ''; }
  catch(e){ items = []; householdId = ''; }
}
function saveLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  localStorage.setItem(HOUSEHOLD_KEY, householdId || '');
}

function ensureSelectOption(selectId, value){
  if(!value) return;
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const exists = Array.from(sel.options).some(o => o.value === value);
  if(!exists){
    const opt = document.createElement('option');
    opt.value = value; opt.textContent = value;
    sel.appendChild(opt);
  }
}

function setHousehold(id){
  householdId = (id||'').trim();
  saveLocal();
  $('#householdId').value = householdId;
  const url = new URL(location.href);
  url.searchParams.set('h', householdId || '');
  history.replaceState(null, '', url.toString());
  renderStatus();
}
function newHouseholdId(){
  return Array.from({length:20}, ()=>Math.floor(Math.random()*36).toString(36)).join('');
}
async function copyShareLink(){
  const url = new URL(location.href);
  url.searchParams.set('h', householdId);
  try{ await navigator.clipboard.writeText(url.toString()); alert('Delingslink kopieret ✔'); }
  catch(e){ prompt('Kopiér delingslink:', url.toString()); }
}

function renderStatus(ok){
  const el = $('#syncStatus');
  const t = $('#syncText');
  if(!householdId){ el.className='status off'; t.textContent='Vælg/indsæt et Husstands-ID for at starte sync.'; return; }
  if(syncing){ el.className='status'; t.textContent='Synkroniserer…'; return; }
  if(ok === false){ el.className='status err'; t.textContent='Sync-fejl – arbejder offline. Prøver igen om lidt.'; return; }
  el.className='status ok'; t.textContent='Online og synkroniseret';
}
async function pull(){
  if(!householdId) return;
  syncing = true; renderStatus();
  try{
    const r = await fetch(`${API}?id=${encodeURIComponent(householdId)}`, { method:'GET' });
    const data = await r.json();
    if(!data.ok) throw new Error('Serverfejl');
    const sMap = new Map((data.items||[]).map(i => [i.id, i]));
    const lMap = new Map((items||[]).map(i => [i.id, i]));
    for(const [id, si] of sMap){
      const li = lMap.get(id);
      const sLU = Number(si.lastUpdated||0);
      const lLU = Number(li?.lastUpdated||0);
      if(!li || sLU > lLU) lMap.set(id, si);
    }
    items = Array.from(lMap.values()).filter(x => !x._deleted);
    version = data.version || 0;
    saveLocal(); render(); renderStatus(true);
  }catch(e){ console.error(e); renderStatus(false); }
  finally{ syncing=false; renderStatus(); }
}
let syncQueued=false;
async function push(){
  if(!householdId) return;
  syncing = true; renderStatus();
  try{
    const r = await fetch(`${API}?id=${encodeURIComponent(householdId)}`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ items, version, clientId })
    });
    const data = await r.json();
    if(!data.ok) throw new Error('Serverfejl');
    items = (data.items||[]).filter(x => !x._deleted);
    version = data.version || (version+1);
    saveLocal(); render(); renderStatus(true);
  }catch(e){ console.error(e); renderStatus(false); }
  finally{ syncing=false; renderStatus(); }
}
function queuePush(){ if(syncQueued) return; syncQueued=true; setTimeout(async ()=>{ syncQueued=false; await push(); }, 600); }

function daysUntil(dateStr){
  if(!dateStr) return null;
  const d = parseDate(dateStr);
  const now = parseDate(todayStr());
  const diff = Math.round((d - now) / (1000*60*60*24));
  return diff;
}
function statusBadge(it){
  const d = daysUntil(it.bestBefore);
  if(d === null) return '<span class="badge">Ingen dato</span>';
  if(d < 0) return `<span class="badge expired">Udløbet ${Math.abs(d)} d.</span>`;
  if(d <= 3) return `<span class="badge expired">Meget snart (${d} d.)</span>`;
  if(d <= 7) return `<span class="badge expiring">Snart (${d} d.)</span>`;
  return `<span class="badge ok">${d} d.</span>`;
}
function render(){
  const q = $('#search').value.trim().toLowerCase();
  const cat = $('#filterCategory').value;
  const expWithin = parseInt($('#expSoon').value,10);
  const sortBy = $('#sortBy').value;
  let list = items.slice();
  if(q){ list = list.filter(it => [it.name,it.category,it.location,it.notes].filter(Boolean).join(' ').toLowerCase().includes(q)); }
  if(cat){ list = list.filter(it => (it.category || '') === cat); }
  if(expWithin>0){ list = list.filter(it => { const d = daysUntil(it.bestBefore); return d !== null && d <= expWithin; }); }
  list.sort((a,b)=>{
    switch(sortBy){
      case 'name': return (a.name||'').localeCompare(b.name||'', 'da');
      case 'qty': return (parseFloat(b.qty||0) - parseFloat(a.qty||0));
      case 'frozenDate': return (b.frozenDate||'').localeCompare(a.frozenDate||'');
      case 'bestBefore': return ((a.bestBefore||'9999-12-31').localeCompare(b.bestBefore||'9999-12-31'));
      default: return 0;
    }
  });
  const tbody = $('#itemsBody'); tbody.innerHTML='';
  for(const it of list){
    const tr = document.createElement('tr'); tr.tabIndex=0; tr.dataset.id=it.id;
    tr.innerHTML = `
      <td data-label="Vare"><strong>${escapeHtml(it.name || '')}</strong>${it.notes ? '<br><small class="help">'+escapeHtml(it.notes)+'</small>' : ''}</td>
      <td data-label="Mængde">${Number(it.qty||0)} ${escapeHtml(it.unit||'')}</td>
      <td data-label="Kategori">${escapeHtml(it.category||'—')}</td>
      <td data-label="Placering">${escapeHtml(it.location||'—')}</td>
      <td data-label="Indfrosset">${fmt(it.frozenDate)}</td>
      <td data-label="Bedst før">${fmt(it.bestBefore)}</td>
      <td data-label="Status">${statusBadge(it)}</td>
      <td data-label="Handlinger" class="actions">
        <button class="btn secondary" data-action="inc">+1</button>
        <button class="btn secondary" data-action="dec">-1</button>
        <button class="btn ghost" data-action="edit">Rediger</button>
        <button class="btn danger" data-action="delete">Slet</button>
      </td>`;
    tbody.appendChild(tr);
  }
  const total = items.length;
  const totalQty = items.reduce((s,it)=>s + (parseFloat(it.qty)||0),0);
  const expSoon = items.filter(it => { const d = daysUntil(it.bestBefore); return d !== null && d <= 7; }).length;
  $('#counts').textContent = `Antal linjer: ${total} • Samlet mængde: ${totalQty} • Udløber ≤7 dage: ${expSoon}`;
}
function resetForm(clearId=true){
  $('#itemForm').reset(); $('#frozenDate').value = todayStr(); if(clearId) $('#itemId').value=''; $('#saveBtn').textContent = 'Gem';
}
function addOrUpdateFromForm(){
  const id = $('#itemId').value || uid();
  const it = {
    id, name: $('#name').value.trim(), qty: parseFloat($('#qty').value||0), unit: $('#unit').value,
    category: $('#category').value, location: $('#location').value,
    frozenDate: $('#frozenDate').value || null, bestBefore: $('#bestBefore').value || null,
    notes: $('#notes').value.trim(), lastUpdated: nowMs()
  };
  if(!it.name){ $('#formStatus').textContent='Varenavn er påkrævet.'; return; }
  const idx = items.findIndex(x => x.id===id);
  if(idx>=0) items[idx]=it; else items.push(it);
  saveLocal(); render(); $('#formStatus').textContent='Gemt ✔'; resetForm(false); queuePush();
}
function softDelete(id){
  const idx = items.findIndex(x => x.id===id); if(idx<0) return;
  const it = items[idx]; items[idx] = { ...it, _deleted:true, lastUpdated: nowMs() };
  saveLocal(); render(); queuePush();
}
function incDec(id, delta){
  const it = items.find(x => x.id===id); if(!it) return;
  it.qty = Math.max(0, (parseFloat(it.qty)||0) + delta); it.lastUpdated = nowMs();
  saveLocal(); render(); queuePush();
}
function toCsv(list){
  const header = ['id','name','qty','unit','category','location','frozenDate','bestBefore','notes'];
  const lines = [header.join(',')];
  for(const it of list){
    const row = header.map(k => {
      let v = (it[k] ?? '').toString();
      if(v.includes('"') || v.includes(',') || v.includes('\n')){ v = '"' + v.replace(/"/g,'""') + '"'; }
      return v;
    });
    lines.push(row.join(','));
  }
  return lines.join('\n');
}
function download(filename, content, mime='text/plain'){
  const blob = new Blob([content], {type: mime});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
}
function parseCsv(text){
  const rows = []; let i=0, field='', row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else inQuotes=false; }
      else field+=c;
    }else{
      if(c==='"'){ inQuotes=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n' || c==='\r'){ if(field!=='' || row.length>0){ row.push(field); rows.push(row); } field=''; row=[]; if(c==='\r' && text[i+1]==='\n') i++; }
      else field+=c;
    }
    i++;
  }
  if(field!=='' || row.length>0){ row.push(field); rows.push(row); }
  return rows;
}
function importCsvText(text){
  const rows = parseCsv(text); if(rows.length===0) return;
  const header = rows[0].map(h => h.trim());
  const idx = {id: header.indexOf('id'), name: header.indexOf('name'), qty: header.indexOf('qty'), unit: header.indexOf('unit'),
               category: header.indexOf('category'), location: header.indexOf('location'),
               frozenDate: header.indexOf('frozenDate'), bestBefore: header.indexOf('bestBefore'), notes: header.indexOf('notes')};
  const newItems = [];
  for(let r=1;r<rows.length;r++){
    const cells = rows[r]; if(!cells.length) continue;
    const name = (idx.name>=0 ? cells[idx.name] : '').trim(); if(!name) continue;
    newItems.push({
      id: (idx.id>=0 && cells[idx.id]) ? cells[idx.id] : uid(),
      name, qty: parseFloat(idx.qty>=0 ? (cells[idx.qty]||'0') : '0') || 0,
      unit: idx.unit>=0 ? (cells[idx.unit]||'') : '',
      category: idx.category>=0 ? (cells[idx.category]||'') : '',
      location: idx.location>=0 ? (cells[idx.location]||'') : '',
      frozenDate: idx.frozenDate>=0 ? (cells[idx.frozenDate]||'') : '',
      bestBefore: idx.bestBefore>=0 ? (cells[idx.bestBefore]||'') : '',
      notes: idx.notes>=0 ? (cells[idx.notes]||'') : '',
      lastUpdated: nowMs()
    });
  }
  if(!confirm(`Importér ${newItems.length} linjer? Dette lægger dem oven i de eksisterende.`)) return;
  items = items.concat(newItems); saveLocal(); render(); queuePush();
}

window.addEventListener('DOMContentLoaded', async () => {
  loadLocal();
  const sp = new URLSearchParams(location.search);
  const hFromUrl = sp.get('h'); if(hFromUrl) householdId = hFromUrl;
  $('#householdId').value = householdId;
  $('#frozenDate').value = todayStr(); render();

  $('#itemForm').addEventListener('submit', (e)=>{ e.preventDefault(); addOrUpdateFromForm(); });
  $('#resetBtn').addEventListener('click', ()=> resetForm());
  ['search','filterCategory','sortBy','expSoon'].forEach(id=>{ $('#'+id).addEventListener('input', render); $('#'+id).addEventListener('change', render); });

  $('#exportCsv').addEventListener('click', (e)=>{ e.preventDefault(); download('fryser.csv', toCsv(items), 'text/csv'); });
  $('#importCsv').addEventListener('click', (e)=>{ e.preventDefault(); $('#importFile').click(); });
  $('#importFile').addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; const text=await file.text(); importCsvText(text); e.target.value=''; });
  $('#clearAll').addEventListener('click', ()=>{ if(confirm('Er du sikker på, at du vil slette ALT?')){ items=[]; saveLocal(); render(); queuePush(); } });

  $('#itemsBody').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const tr = e.target.closest('tr'); const id = tr?.dataset?.id; if(!id) return;
    switch(btn.dataset.action){
      case 'inc': incDec(id, +1); break;
      case 'dec': incDec(id, -1); break;
      case 'edit': {
        const it = items.find(x => x.id===id);
        if(it){
          $('#itemId').value = it.id; $('#name').value = it.name || ''; $('#qty').value = it.qty || 0; $('#unit').value = it.unit || 'stk';
          $('#category').value = it.category || '';
          ensureSelectOption('location', it.location || '');
          $('#location').value = it.location || '';
          $('#frozenDate').value = it.frozenDate || ''; $('#bestBefore').value = it.bestBefore || ''; $('#notes').value = it.notes || '';
          $('#saveBtn').textContent = 'Opdatér'; $('#name').focus();
        }
        break;
      }
      case 'delete': if(confirm('Slet denne vare?')) softDelete(id); break;
    }
  });
  $('#itemsBody').addEventListener('keydown', (e)=>{
    if(e.key!=='+' && e.key!=='-') return;
    const tr = e.target.closest('tr'); if(!tr) return;
    const id = tr.dataset.id;
    if(e.key=== '+') incDec(id, +1); if(e.key=== '-') incDec(id, -1);
    e.preventDefault();
  });

  $('#createHousehold').addEventListener('click', ()=>{ const id=newHouseholdId(); setHousehold(id); alert('Ny husstand oprettet ✔ Del linket med familien.'); queuePush(); });
  $('#applyHousehold').addEventListener('click', ()=> setHousehold($('#householdId').value));
  $('#copyShare').addEventListener('click', copyShareLink);

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

  await pull();
  setInterval(pull, 30000);
});
</script>
</body>
</html>
